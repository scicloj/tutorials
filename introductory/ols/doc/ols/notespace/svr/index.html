<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://stackpath.bootstrapcdn.com/bootswatch/4.5.0/sandstone/bootstrap.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/solarized-light.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/24.0.0/styles/ag-grid.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/24.0.0/styles/ag-theme-balham.min.css" rel="stylesheet" type="text/css">
        <link href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" rel="stylesheet" type="text/css">
    </head>
    <body>
        <p id="loading">Loading ...</p>
        <div id="app"></div>
    </body>
    <script src="https://cdn.jsdelivr.net/gh/scicloj/gorilla-notes@master/dist/0.5.0-SNAPSHOT-5/main.js"></script>
    <script>
     shadow.loader.load("main");
     gorilla_notes.main.main_BANG_(false, "{:options {:reverse-notes? false, :header? false, :notes-in-cards? false, :custom-header [:div {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} \"(notespace)\" [:p \"Sat Dec 12 22:26:46 IST 2020\"] nil nil [:hr]], :custom-footer [:div [:hr]]}, :ids [\"500\" \"501\" \"502\" \"503\" \"504\" \"505\" \"506\" \"507\" \"508\" \"509\" \"510\" \"511\" \"512\" \"513\" \"514\" \"515\" \"516\" \"517\" \"518\" \"519\" \"520\" \"521\" \"522\" \"523\" \"524\" \"525\"], :id->content {\"499\" [:div [:p/code {:code \"(svr-predict-scalar svrmodel {:Used_Duration 1.16 :Used_Rating_Score 6.0 :Country \\\"BH\\\" :Sector \\\"Ovy_naq_Gnf\\\"})\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"498\" [:div [:p/code {:code \"(ols-predict-scalar newmodel {:Used_Duration 1.16 :Used_Rating_Score 6.0 :Country \\\"BH\\\" :Sector \\\"Ovy_naq_Gnf\\\"})\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"488\" [:div [:p/code {:code \"(defn get-svr-model-output [dataset]\\n  (-> dataset\\n      (svr-model-definition)\\n      (prepare-data :svr)\\n      (svr-full-training 0.05 1000)))\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"508\" [:div [:p/code {:code \"(defn prepare-data\\n  \\\"The scaling parameters are added here for features that had been transformed. model-type is :ols or :svr\\\"\\n  [model-definition model-type]\\n  (let [transformed (build-many-columns (:dataset model-definition) (:transformations model-definition))\\n        scaler (dsm/fit-std-scale (ds/select-columns transformed (get-in model-definition [:std-scale :columns])))\\n        clean-data (-> transformed\\n                       (one-hot-reducer (get-in model-definition [:one-hot :columns]) (get-in model-definition [:one-hot :removals]))\\n                       (dsm/transform-std-scale scaler))\\n        features-ds (ds/remove-columns clean-data [(:id-name model-definition) (get-in model-definition [:y :column])])]\\n    (assoc model-definition\\n      :std-scale      (assoc (:std-scale model-definition) :scaler scaler)\\n      :features-cols  (ds/column-names features-ds) ;we need to know the order to predict later\\n      :ols-formula    (if (= :ols model-type) (Formula/lhs (name (get-in model-definition [:y :column])))) ; warning - you need a name here, keyword will fail\\n      :dataframe      (if (= :ols model-type) (ds-smile/dataset->dataframe (ds/remove-column clean-data (:id-name model-definition))))\\n      :sigma          (if (= :svr model-type) (Math/sqrt (* 0.5 (ds/column-count features-ds) (dfn/variance (vec (flatten (ds/value-reader features-ds)))))))\\n      :features-array (if (= :svr model-type) (.toArray (ds-smile/dataset->dataframe features-ds)))\\n      :y-array        (if (= :svr model-type) (.array (ds-smile/column->smile-column (clean-data (get-in model-definition [:y :column]))))))))\", :bg-class \"bg-light\"}] [:div nil]], \"522\" [:div [:p/code {:code \"(ds/filter-column res :Bond \\\"Bond-42\\\")\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"resources/bonds.csv [1 9]:\\n\\n|   :Bond |     :Sector | :Country | :Used_Duration | :Used_Rating_Score | :Used_ZTW | :legacy |  :new |  :svr |\\n|---------|-------------|----------|----------------|--------------------|-----------|---------|-------|-------|\\n| Bond-42 | Ovy_naq_Gnf |       BH |           1.16 |                6.0 |      75.2 |   118.0 | 103.1 | 75.15 |\\n\\n\"}]]], \"475\" [:div [:p/code {:code \"(comment\\n  ;; we'll be calling some Java methods\\n  ;; commenting this out, since it fails as a notespace note\\n  ;; (Can't set!: *warn-on-reflection* from non-binding thread)\\n  (set! *warn-on-reflection* true))\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"479\" [:div [:p/code {:code \"(defn build-column\\n  \\\"We can either assoc a new column or build from existing columns\\\"\\n  [dataset line]\\n  (if (contains? line :assoc-fn)\\n    (assoc dataset (:column line) ((:assoc-fn line) dataset))\\n    (ds/column-map dataset (:column line) (:map-fn line) nil (:arg-cols line))))\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"520\" [:div [:p/code {:code \"(def legacymodel (get-legacy-model-output qm))\", :bg-class \"bg-light\"}] [:div nil]], \"504\" [:div [:p/code {:code \"(defn svr-model-definition\\n  \\\"Used_ZTW = SVR(Used_Duration, Used_Rating_Score, Country, Sector)\\\"\\n  [dataset]\\n  {:dataset         dataset\\n   :id-name         :Bond\\n   :y               {:column :Used_ZTW :predict-fn identity}\\n   :one-hot         {:columns [:Country :Sector] :removals [:Country-BH :Sector-Fvanapvny]}\\n   :std-scale       {:columns [:Used_Duration :Used_Rating_Score] :scaler nil}})\", :bg-class \"bg-light\"}] [:div nil]], \"480\" [:div [:p/code {:code \"(defn build-many-columns [dataset features]\\n  (reduce build-column dataset features))\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"485\" [:div [:p/code {:code \"(defn svr-full-training [data eps C]\\n  \\\"Putting it all together, the model / the predictions and the R2\\\"\\n  ;todo find out why I'm still getting a Reflection warning: call to method predict on smile.base.svm.KernelMachine can't be resolved (no such method)\\n  (let [kernel-machine (fit-RBF-SVR (:features-array data) (:y-array data) (:sigma data) eps C)\\n        raw-predictions (.predict ^KernelMachine kernel-machine (:features-array data))\\n        rss (RSS/of (:y-array data) raw-predictions)]\\n    (merge data {:kernel-machine kernel-machine :predictions ((get-in data [:y :predict-fn]) (vec raw-predictions)) :rsq (- 1 (/ rss (dfn/distance-squared (:y-array data) (repeat 0.))))})))\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"525\" [:div [:p/code {:code \"(svr-predict-scalar svrmodel {:Used_Duration 1.16 :Used_Rating_Score 6.0 :Country \\\"BH\\\" :Sector \\\"Ovy_naq_Gnf\\\"})\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"75.14854935593735\\n\"}]]], \"492\" [:div [:p/code {:code \"(def svrmodel (get-svr-model-output qm))\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"490\" [:div [:p/code {:code \"(defn get-new-model-output [dataset]\\n  (-> dataset\\n      (new-model-definition)\\n      (prepare-data :ols)\\n      (ols-full-training)))\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"484\" [:div [:p/code {:code \"(defn fit-RBF-SVR [x y sigma eps C]\\n  \\\"This is the SVR fit function, returning a smile.base.svm.KernelMachine which we can use to predict.\\n  x id a double double array, y is a double array, the rest are scalars.\\n  tol = 0.01 is irrelevant for the RBF (= Gaussian) kernel.\\n  sigma tunes the Kernel. The Python sklearn default is gamma = 'scale' where gamma = 1 / (2 * sigma^2)\\n  'scale' means gamma = 1 / (n_features * x.var()) hence sigma = sqrt(0.5 * n_features * x.var()) where x is flattened\\\"\\n  (.fit (SVR. (GaussianKernel. sigma) eps C 0.01) x y))\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"476\" [:div [:p/code {:code \"(defn legacy-model-definition\\n  \\\"log(Used_ZTW) = a.Used_Duration + b.Used_Rating_Score + categorical variables\\\"\\n  [dataset]\\n  {:dataset         dataset\\n   :id-name         :Bond\\n   :y               {:column :Used_ZTW :predict-fn dfn/exp}\\n   :transformations [{:column :Used_ZTW :assoc-fn #(dfn/log (% :Used_ZTW))}]\\n   :one-hot         {:columns [:Country :Sector] :removals [:Country-BH :Sector-Fvanapvny]}\\n   :std-scale       {:columns [:Used_Duration :Used_Rating_Score] :scaler nil}})\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"521\" [:div [:p/code {:code \"(def res (assoc qm :legacy (:predictions legacymodel) :new (:predictions newmodel) :svr (:predictions svrmodel)))\", :bg-class \"bg-light\"}] [:div nil]], \"503\" [:div [:p/code {:code \"(defn new-model-definition\\n  \\\"log(Used_ZTW) = a.log(Used_Duration) + b.Used_Rating_Score + categorical variables\\\"\\n  [dataset]\\n  {:dataset         dataset\\n   :id-name         :Bond\\n   :y               {:column :Used_ZTW :predict-fn dfn/exp}\\n   :transformations [{:column :Used_ZTW          :assoc-fn #(dfn/log (% :Used_ZTW))}\\n                     {:column :Used_Duration     :assoc-fn #(dfn/log (% :Used_Duration))}]\\n   :one-hot         {:columns [:Country :Sector] :removals [:Country-BH :Sector-Fvanapvny]}\\n   :std-scale       {:columns [:Used_Duration :Used_Rating_Score] :scaler nil}})\", :bg-class \"bg-light\"}] [:div nil]], \"493\" [:div [:p/code {:code \"(def newmodel (get-new-model-output qm))\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"512\" [:div [:p/code {:code \"(defn ols-predict-scalar [data xmap]\\n  \\\"The order of the data needs to match the order of the training data AND we need the intercept first, set at 1.0\\n  Ugly hack here - normalizer is set to use log for new model\\n  \\\"\\n  (letfn [(normalizer [id log?] (let [{m :mean s :standard-deviation} (get-in data [:std-scale :scaler id])] (/ (- (if log? (Math/log (xmap id)) (xmap id)) m) s)))]\\n    ((get-in data [:y :predict-fn])\\n     (.predict\\n       ^LinearModel (:ols data)\\n       (double-array\\n         (into [1.0] (for [c (:features-cols data)]          ;into [1.0] is the intercept. It's not obvious!!!\\n                       (condp = c\\n                         :Used_Duration (normalizer :Used_Duration (some #{:Used_Duration} (map :column (:transformations data))))\\n                         :Used_Rating_Score (normalizer :Used_Rating_Score false)\\n                         (keyword (str \\\"Country-\\\" (xmap :Country))) 1.0\\n                         (keyword (str \\\"Sector-\\\" (xmap :Sector))) 1.0\\n                         0.0))))))))\", :bg-class \"bg-light\"}] [:div nil]], \"489\" [:div [:p/code {:code \"(defn get-legacy-model-output [dataset]\\n  (-> dataset\\n      (legacy-model-definition)\\n      (prepare-data :ols)\\n      (ols-full-training)))\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"497\" [:div [:p/code {:code \"(ols-predict-scalar legacymodel {:Used_Duration 1.16 :Used_Rating_Score 6.0 :Country \\\"BH\\\" :Sector \\\"Ovy_naq_Gnf\\\"})\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"482\" [:div [:p/code {:code \"(defn prepare-data\\n  \\\"The scaling parameters are added here for features that had been transformed. model-type is :ols or :svr\\\"\\n  [model-definition model-type]\\n  (let [transformed (build-many-columns (:dataset model-definition) (:transformations model-definition))\\n        scaler (dsm/fit-std-scale (ds/select-columns transformed (get-in model-definition [:std-scale :columns])))\\n        clean-data (-> transformed\\n                       (one-hot-reducer (get-in model-definition [:one-hot :columns]) (get-in model-definition [:one-hot :removals]))\\n                       (dsm/transform-std-scale scaler))\\n        features-ds (ds/remove-columns clean-data [(:id-name model-definition) (get-in model-definition [:y :column])])]\\n    (assoc model-definition\\n      :std-scale      (assoc (:std-scale model-definition) :scaler scaler)\\n      :features-cols  (ds/column-names features-ds) ;we need to know the order to predict later\\n      :ols-formula    (if (= :ols model-type) (Formula/lhs (name (get-in model-definition [:y :column])))) ; warning - you need a name here, keyword will fail\\n      :dataframe      (if (= :ols model-type) (ds-smile/dataset->dataframe (ds/remove-column clean-data (:id-name model-definition))))\\n      :sigma          (if (= :svr model-type) (Math/sqrt (* 0.5 (ds/column-count features-ds) (dfn/variance (vec (flatten (ds/value-reader features-ds)))))))\\n      :features-array (if (= :svr model-type) (.toArray (ds-smile/dataset->dataframe features-ds)))\\n      :y-array        (if (= :svr model-type) (.array (ds-smile/column->smile-column (clean-data (get-in model-definition [:y :column]))))))))\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"477\" [:div [:p/code {:code \"(defn new-model-definition\\n  \\\"log(Used_ZTW) = a.log(Used_Duration) + b.Used_Rating_Score + categorical variables\\\"\\n  [dataset]\\n  {:dataset         dataset\\n   :id-name         :Bond\\n   :y               {:column :Used_ZTW :predict-fn dfn/exp}\\n   :transformations [{:column :Used_ZTW          :assoc-fn #(dfn/log (% :Used_ZTW))}\\n                     {:column :Used_Duration     :assoc-fn #(dfn/log (% :Used_Duration))}]\\n   :one-hot         {:columns [:Country :Sector] :removals [:Country-BH :Sector-Fvanapvny]}\\n   :std-scale       {:columns [:Used_Duration :Used_Rating_Score] :scaler nil}})\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"511\" [:div [:p/code {:code \"(defn svr-full-training [data eps C]\\n  \\\"Putting it all together, the model / the predictions and the R2\\\"\\n  ;todo find out why I'm still getting a Reflection warning: call to method predict on smile.base.svm.KernelMachine can't be resolved (no such method)\\n  (let [kernel-machine (fit-RBF-SVR (:features-array data) (:y-array data) (:sigma data) eps C)\\n        raw-predictions (.predict ^KernelMachine kernel-machine (:features-array data))\\n        rss (RSS/of (:y-array data) raw-predictions)]\\n    (merge data {:kernel-machine kernel-machine :predictions ((get-in data [:y :predict-fn]) (vec raw-predictions)) :rsq (- 1 (/ rss (dfn/distance-squared (:y-array data) (repeat 0.))))})))\", :bg-class \"bg-light\"}] [:div nil]], \"483\" [:div [:p/code {:code \"(defn ols-full-training\\n  \\\"Putting it all together, the model / the predictions and the R2\\\"\\n  [data]\\n  (let [ols (OLS/fit (:ols-formula data) (:dataframe data))]\\n    (merge data {:ols ols :predictions ((get-in data [:y :predict-fn]) (vec (.predict ^LinearModel ols ^DataFrame (:dataframe data)))) :rsq (.RSquared ^LinearModel ols)})))\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"496\" [:div [:p/code {:code \"(ds/filter-column res :Bond \\\"Bond-42\\\")\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"474\" [:div nil [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"524\" [:div [:p/code {:code \"(ols-predict-scalar newmodel {:Used_Duration 1.16 :Used_Rating_Score 6.0 :Country \\\"BH\\\" :Sector \\\"Ovy_naq_Gnf\\\"})\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"103.1329755725272\\n\"}]]], \"518\" [:div [:p/code {:code \"(def svrmodel (get-svr-model-output qm))\", :bg-class \"bg-light\"}] [:div nil]], \"507\" [:div [:p/code {:code \"(defn one-hot-reducer\\n  \\\"Removals only important for OLS models with small amount of features to avoid colinearity\\\"\\n  [source-dataset cols removals]\\n  (ds/remove-columns\\n    (reduce (fn [dataset col] (categorical/transform-one-hot dataset (categorical/fit-one-hot dataset col))) source-dataset cols)\\n    removals))\", :bg-class \"bg-light\"}] [:div nil]], \"481\" [:div [:p/code {:code \"(defn one-hot-reducer\\n  \\\"Removals only important for OLS models with small amount of features to avoid colinearity\\\"\\n  [source-dataset cols removals]\\n  (ds/remove-columns\\n    (reduce (fn [dataset col] (categorical/transform-one-hot dataset (categorical/fit-one-hot dataset col))) source-dataset cols)\\n    removals))\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"502\" [:div [:p/code {:code \"(defn legacy-model-definition\\n  \\\"log(Used_ZTW) = a.Used_Duration + b.Used_Rating_Score + categorical variables\\\"\\n  [dataset]\\n  {:dataset         dataset\\n   :id-name         :Bond\\n   :y               {:column :Used_ZTW :predict-fn dfn/exp}\\n   :transformations [{:column :Used_ZTW :assoc-fn #(dfn/log (% :Used_ZTW))}]\\n   :one-hot         {:columns [:Country :Sector] :removals [:Country-BH :Sector-Fvanapvny]}\\n   :std-scale       {:columns [:Used_Duration :Used_Rating_Score] :scaler nil}})\", :bg-class \"bg-light\"}] [:div nil]], \"510\" [:div [:p/code {:code \"(defn fit-RBF-SVR [x y sigma eps C]\\n  \\\"This is the SVR fit function, returning a smile.base.svm.KernelMachine which we can use to predict.\\n  x id a double double array, y is a double array, the rest are scalars.\\n  tol = 0.01 is irrelevant for the RBF (= Gaussian) kernel.\\n  sigma tunes the Kernel. The Python sklearn default is gamma = 'scale' where gamma = 1 / (2 * sigma^2)\\n  'scale' means gamma = 1 / (n_features * x.var()) hence sigma = sqrt(0.5 * n_features * x.var()) where x is flattened\\\"\\n  (.fit (SVR. (GaussianKernel. sigma) eps C 0.01) x y))\", :bg-class \"bg-light\"}] [:div nil]], \"486\" [:div [:p/code {:code \"(defn ols-predict-scalar [data xmap]\\n  \\\"The order of the data needs to match the order of the training data AND we need the intercept first, set at 1.0\\n  Ugly hack here - normalizer is set to use log for new model\\n  \\\"\\n  (letfn [(normalizer [id log?] (let [{m :mean s :standard-deviation} (get-in data [:std-scale :scaler id])] (/ (- (if log? (Math/log (xmap id)) (xmap id)) m) s)))]\\n    ((get-in data [:y :predict-fn])\\n     (.predict\\n       ^LinearModel (:ols data)\\n       (double-array\\n         (into [1.0] (for [c (:features-cols data)]          ;into [1.0] is the intercept. It's not obvious!!!\\n                       (condp = c\\n                         :Used_Duration (normalizer :Used_Duration (some #{:Used_Duration} (map :column (:transformations data))))\\n                         :Used_Rating_Score (normalizer :Used_Rating_Score false)\\n                         (keyword (str \\\"Country-\\\" (xmap :Country))) 1.0\\n                         (keyword (str \\\"Sector-\\\" (xmap :Sector))) 1.0\\n                         0.0))))))))\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"519\" [:div [:p/code {:code \"(def newmodel (get-new-model-output qm))\", :bg-class \"bg-light\"}] [:div nil]], \"505\" [:div [:p/code {:code \"(defn build-column\\n  \\\"We can either assoc a new column or build from existing columns\\\"\\n  [dataset line]\\n  (if (contains? line :assoc-fn)\\n    (assoc dataset (:column line) ((:assoc-fn line) dataset))\\n    (ds/column-map dataset (:column line) (:map-fn line) nil (:arg-cols line))))\", :bg-class \"bg-light\"}] [:div nil]], \"509\" [:div [:p/code {:code \"(defn ols-full-training\\n  \\\"Putting it all together, the model / the predictions and the R2\\\"\\n  [data]\\n  (let [ols (OLS/fit (:ols-formula data) (:dataframe data))]\\n    (merge data {:ols ols :predictions ((get-in data [:y :predict-fn]) (vec (.predict ^LinearModel ols ^DataFrame (:dataframe data)))) :rsq (.RSquared ^LinearModel ols)})))\", :bg-class \"bg-light\"}] [:div nil]], \"500\" [:div nil [:div nil]], \"495\" [:div [:p/code {:code \"(def res (assoc qm :legacy (:predictions legacymodel) :new (:predictions newmodel) :svr (:predictions svrmodel)))\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"491\" [:div [:p/code {:code \"(def qm (ds/->dataset \\\"resources/bonds.csv\\\" {:key-fn keyword}) )\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"517\" [:div [:p/code {:code \"(def qm (ds/->dataset \\\"resources/bonds.csv\\\" {:key-fn keyword}) )\", :bg-class \"bg-light\"}] [:div nil]], \"514\" [:div [:p/code {:code \"(defn get-svr-model-output [dataset]\\n  (-> dataset\\n      (svr-model-definition)\\n      (prepare-data :svr)\\n      (svr-full-training 0.05 1000)))\", :bg-class \"bg-light\"}] [:div nil]], \"506\" [:div [:p/code {:code \"(defn build-many-columns [dataset features]\\n  (reduce build-column dataset features))\", :bg-class \"bg-light\"}] [:div nil]], \"478\" [:div [:p/code {:code \"(defn svr-model-definition\\n  \\\"Used_ZTW = SVR(Used_Duration, Used_Rating_Score, Country, Sector)\\\"\\n  [dataset]\\n  {:dataset         dataset\\n   :id-name         :Bond\\n   :y               {:column :Used_ZTW :predict-fn identity}\\n   :one-hot         {:columns [:Country :Sector] :removals [:Country-BH :Sector-Fvanapvny]}\\n   :std-scale       {:columns [:Used_Duration :Used_Rating_Score] :scaler nil}})\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"515\" [:div [:p/code {:code \"(defn get-legacy-model-output [dataset]\\n  (-> dataset\\n      (legacy-model-definition)\\n      (prepare-data :ols)\\n      (ols-full-training)))\", :bg-class \"bg-light\"}] [:div nil]], \"516\" [:div [:p/code {:code \"(defn get-new-model-output [dataset]\\n  (-> dataset\\n      (new-model-definition)\\n      (prepare-data :ols)\\n      (ols-full-training)))\", :bg-class \"bg-light\"}] [:div nil]], \"494\" [:div [:p/code {:code \"(def legacymodel (get-legacy-model-output qm))\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"513\" [:div [:p/code {:code \"(defn svr-predict-scalar [data xmap]\\n  \\\"The order of the data needs to match the order of the training data.\\\"\\n  ;todo find out why I'm still getting a Reflection warning: call to method predict on smile.base.svm.KernelMachine can't be resolved (no such method)\\n  (letfn [(normalizer [id] (let [{m :mean s :standard-deviation} (get-in data [:std-scale :scaler id])] (/ (- (xmap id) m) s)))]\\n    ((get-in data [:y :predict-fn])\\n     (.predict\\n       ^KernelMachine (:kernel-machine data)\\n       (double-array\\n         (into [] (for [c (:features-cols data)]\\n                    (condp = c\\n                      :Used_Duration (normalizer :Used_Duration)\\n                      :Used_Rating_Score (normalizer :Used_Rating_Score)\\n                      (keyword (str \\\"Country-\\\" (xmap :Country))) 1.0\\n                      (keyword (str \\\"Sector-\\\" (xmap :Sector))) 1.0\\n                      0.0))))))))\", :bg-class \"bg-light\"}] [:div nil]], \"501\" [:div [:p/code {:code \"(comment\\n  ;; we'll be calling some Java methods\\n  ;; commenting this out, since it fails as a notespace note\\n  ;; (Can't set!: *warn-on-reflection* from non-binding thread)\\n  (set! *warn-on-reflection* true))\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"nil\\n\"}]]], \"487\" [:div [:p/code {:code \"(defn svr-predict-scalar [data xmap]\\n  \\\"The order of the data needs to match the order of the training data.\\\"\\n  ;todo find out why I'm still getting a Reflection warning: call to method predict on smile.base.svm.KernelMachine can't be resolved (no such method)\\n  (letfn [(normalizer [id] (let [{m :mean s :standard-deviation} (get-in data [:std-scale :scaler id])] (/ (- (xmap id) m) s)))]\\n    ((get-in data [:y :predict-fn])\\n     (.predict\\n       ^KernelMachine (:kernel-machine data)\\n       (double-array\\n         (into [] (for [c (:features-cols data)]\\n                    (condp = c\\n                      :Used_Duration (normalizer :Used_Duration)\\n                      :Used_Rating_Score (normalizer :Used_Rating_Score)\\n                      (keyword (str \\\"Country-\\\" (xmap :Country))) 1.0\\n                      (keyword (str \\\"Sector-\\\" (xmap :Sector))) 1.0\\n                      0.0))))))))\", :bg-class \"bg-light\"}] [:div [:p {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} [:small \"(not evaluated yet)\"]]]], \"523\" [:div [:p/code {:code \"(ols-predict-scalar legacymodel {:Used_Duration 1.16 :Used_Rating_Score 6.0 :Country \\\"BH\\\" :Sector \\\"Ovy_naq_Gnf\\\"})\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"118.01535809799988\\n\"}]]]}}");
     document.getElementById("loading").remove();
    </script>
</html>
